{{- if .Values.istio.enabled }}
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ .Values.istio.virtualServices.apiService.name }}
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "myhealth.labels" . | nindent 4 }}
spec:
  hosts:
    {{- range .Values.istio.virtualServices.apiService.hosts }}
    - "{{ . }}"
    {{- end }}
  gateways:
    {{- range .Values.istio.virtualServices.apiService.gateways }}
    - "{{ . }}"
    {{- end }}
  http:
    # API Service routes - /api prefix
    - match:
        - uri:
            prefix: "/api"
      route:
        - destination:
            host: api-service
            port:
              number: 8080
          weight: 100
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
    
    # Helm chart repository - /charts prefix
    # This will be served by GitHub Pages, redirect externally
    - match:
        - uri:
            prefix: "/charts"
      redirect:
        uri: "https://asian-code.github.io/myapp-kubernetes/charts"
        authority: "asian-code.github.io"
    
    # Frontend - serve everything else (assumes you'll deploy frontend separately)
    # Adjust this if you have a frontend service in the cluster
    - match:
        - uri:
            prefix: "/"
      route:
        - destination:
            host: frontend-service  # You'll need to create this
            port:
              number: 80
          weight: 100
{{- end }}
