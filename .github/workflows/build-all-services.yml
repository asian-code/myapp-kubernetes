name: 'Build All Services (Conditional)'

on:
  pull_request:
    paths:
      - 'services/**'
      - '.github/workflows/build-all-services.yml'
      - '.github/workflows/build-service.yml'
  push:
    branches:
      - main
    paths:
      - 'services/**'

jobs:
  detect-changes:
    name: 'Detect Changed Services'
    runs-on: ubuntu-latest
    outputs:
      api_changed: ${{ steps.filter.outputs.api }}
      processor_changed: ${{ steps.filter.outputs.processor }}
      collector_changed: ${{ steps.filter.outputs.collector }}
      shared_changed: ${{ steps.filter.outputs.shared }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Check changed paths
      uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          api:
            - 'services/api-service/**'
            - 'services/shared/**'
          processor:
            - 'services/data-processor/**'
            - 'services/shared/**'
          collector:
            - 'services/oura-collector/**'
            - 'services/shared/**'
          shared:
            - 'services/shared/**'
  
  build-api-service:
    name: 'Build API Service'
    needs: detect-changes
    if: needs.detect-changes.outputs.api_changed == 'true'
    uses: ./.github/workflows/build-service.yml
    with:
      service_name: api-service
      service_path: api-service
      changed: true
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      NTFY_URL: ${{ secrets.NTFY_URL }}
  
  build-data-processor:
    name: 'Build Data Processor'
    needs: detect-changes
    if: needs.detect-changes.outputs.processor_changed == 'true'
    uses: ./.github/workflows/build-service.yml
    with:
      service_name: data-processor
      service_path: data-processor
      changed: true
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      NTFY_URL: ${{ secrets.NTFY_URL }}
  
  build-oura-collector:
    name: 'Build Oura Collector'
    needs: detect-changes
    if: needs.detect-changes.outputs.collector_changed == 'true'
    uses: ./.github/workflows/build-service.yml
    with:
      service_name: oura-collector
      service_path: oura-collector
      changed: true
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      NTFY_URL: ${{ secrets.NTFY_URL }}
