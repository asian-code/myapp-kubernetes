name: 'Helm Deploy'

on:
  push:
    branches:
      - main
    paths:
      - 'helm/**'
      - 'services/**'
      - '.github/workflows/helm-deploy.yml'

env:
  HELM_CHART_PATH: helm/myhealth
  AWS_REGION: us-east-1
  DOCKER_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

jobs:
  prepare:
    name: 'Prepare Deployment'
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.set-tag.outputs.tag }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set Image Tag
      id: set-tag
      run: echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
  
  deploy-dev:
    name: 'Deploy to Dev'
    runs-on: ubuntu-latest
    needs: prepare
    environment: dev
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: 'v3.13.0'
    
    - name: Add Helm Repos
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1
    
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name myhealth-cluster --region us-east-1
    
    - name: Deploy Helm Chart (Dev)
      run: |
        helm dependency update ${{ env.HELM_CHART_PATH }}
        helm upgrade --install myhealth ${{ env.HELM_CHART_PATH }} \
          --namespace myhealth-dev \
          --create-namespace \
          --values ${{ env.HELM_CHART_PATH }}/values.yaml \
          --set global.environment=dev \
          --set imageRegistry=${{ env.DOCKER_REGISTRY }} \
          --set ouraCollector.image.tag=${{ needs.prepare.outputs.image_tag }} \
          --set dataProcessor.image.tag=${{ needs.prepare.outputs.image_tag }} \
          --set apiService.image.tag=${{ needs.prepare.outputs.image_tag }} \
          --set-string ouraCollector.env.logLevel=debug \
          --set-string dataProcessor.env.logLevel=debug \
          --set-string apiService.env.logLevel=debug \
          --wait --timeout 5m
    
    - name: Verify Deployment (Dev)
      run: |
        kubectl rollout status deployment/data-processor -n myhealth-dev --timeout=5m || true
        kubectl rollout status deployment/api-service -n myhealth-dev --timeout=5m || true
        kubectl get pods -n myhealth-dev
    
    - name: Send Notification - Success
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Deploy to Dev - SUCCESS" \
          -H "Priority: 3" \
          -H "Tags: deployment,dev,success" \
          -d "Helm deployment to Dev completed successfully for ${{ github.repository }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: success()
    
    - name: Send Notification - Failure
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Deploy to Dev - FAILED" \
          -H "Priority: 4" \
          -H "Tags: deployment,dev,failed" \
          -d "Helm deployment to Dev failed. Check workflow at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: failure()
  
  deploy-staging:
    name: 'Deploy to Staging'
    runs-on: ubuntu-latest
    needs: [prepare, deploy-dev]
    environment: staging
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: 'v3.13.0'
    
    - name: Add Helm Repos
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1
    
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name myhealth-cluster --region us-east-1
    
    - name: Deploy Helm Chart (Staging)
      run: |
        helm dependency update ${{ env.HELM_CHART_PATH }}
        helm upgrade --install myhealth ${{ env.HELM_CHART_PATH }} \
          --namespace myhealth-staging \
          --create-namespace \
          --values ${{ env.HELM_CHART_PATH }}/values.yaml \
          --set global.environment=staging \
          --set imageRegistry=${{ env.DOCKER_REGISTRY }} \
          --set ouraCollector.image.tag=${{ needs.prepare.outputs.image_tag }} \
          --set dataProcessor.image.tag=${{ needs.prepare.outputs.image_tag }} \
          --set apiService.image.tag=${{ needs.prepare.outputs.image_tag }} \
          --set-string ouraCollector.env.logLevel=info \
          --set-string dataProcessor.env.logLevel=info \
          --set-string apiService.env.logLevel=info \
          --set ouraCollector.resources.limits.memory=512Mi \
          --set dataProcessor.resources.limits.memory=1Gi \
          --set apiService.resources.limits.memory=1Gi \
          --wait --timeout 5m
    
    - name: Verify Deployment (Staging)
      run: |
        kubectl rollout status deployment/data-processor -n myhealth-staging --timeout=5m || true
        kubectl rollout status deployment/api-service -n myhealth-staging --timeout=5m || true
        kubectl get pods -n myhealth-staging
    
    - name: Send Notification - Success
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Deploy to Staging - SUCCESS" \
          -H "Priority: 3" \
          -H "Tags: deployment,staging,success" \
          -d "Helm deployment to Staging completed successfully for ${{ github.repository }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: success()
    
    - name: Send Notification - Failure
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Deploy to Staging - FAILED" \
          -H "Priority: 4" \
          -H "Tags: deployment,staging,failed" \
          -d "Helm deployment to Staging failed. Check workflow at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: failure()
  
  deploy-prod:
    name: 'Deploy to Production'
    runs-on: ubuntu-latest
    needs: [prepare, deploy-staging]
    environment:
      name: production
      url: https://api.eric-n.com
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: 'v3.13.0'
    
    - name: Add Helm Repos
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1
    
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name myhealth-cluster --region us-east-1
    
    - name: Send Notification - Production Deployment Started
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Production Deployment STARTED" \
          -H "Priority: 4" \
          -H "Tags: deployment,production,started" \
          -d "Production deployment initiated for ${{ github.repository }} by ${{ github.actor }}" \
          "${{ secrets.NTFY_URL }}/cicd"
    
    - name: Deploy Helm Chart (Production)
      run: |
        helm dependency update ${{ env.HELM_CHART_PATH }}
        helm upgrade --install myhealth ${{ env.HELM_CHART_PATH }} \
          --namespace myhealth-prod \
          --create-namespace \
          --values ${{ env.HELM_CHART_PATH }}/values.yaml \
          --set global.environment=prod \
          --set imageRegistry=${{ env.DOCKER_REGISTRY }} \
          --set ouraCollector.image.tag=${{ needs.prepare.outputs.image_tag }} \
          --set dataProcessor.image.tag=${{ needs.prepare.outputs.image_tag }} \
          --set apiService.image.tag=${{ needs.prepare.outputs.image_tag }} \
          --set-string ouraCollector.env.logLevel=warning \
          --set-string dataProcessor.env.logLevel=warning \
          --set-string apiService.env.logLevel=warning \
          --set ouraCollector.replicaCount=2 \
          --set dataProcessor.replicaCount=3 \
          --set apiService.replicaCount=5 \
          --set ouraCollector.resources.limits.memory=512Mi \
          --set dataProcessor.resources.limits.memory=1Gi \
          --set apiService.resources.limits.memory=1Gi \
          --wait --timeout 10m
    
    - name: Verify Deployment (Production)
      run: |
        kubectl rollout status deployment/data-processor -n myhealth-prod --timeout=10m || true
        kubectl rollout status deployment/api-service -n myhealth-prod --timeout=10m || true
        kubectl get pods -n myhealth-prod
        kubectl get services -n myhealth-prod
    
    - name: Health Check
      run: |
        # Wait for service to be ready
        sleep 10
        kubectl port-forward -n myhealth-prod svc/api-service 8080:8080 &
        sleep 2
        curl -f http://localhost:8080/health || echo "Health check may require additional setup"
      continue-on-error: true
    
    - name: Send Notification - Success
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Production Deployment - SUCCESS" \
          -H "Priority: 3" \
          -H "Tags: deployment,production,success" \
          -d "Production deployment completed successfully! Commit: ${{ github.sha }} Repository: ${{ github.repository }} Branch: ${{ github.ref }} Actor: ${{ github.actor }} URL: https://api.eric-n.com" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: success()
    
    - name: Send Notification - Failure
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Production Deployment - FAILED" \
          -H "Priority: 5" \
          -H "Tags: deployment,production,failed,error" \
          -d "Production deployment FAILED! Commit: ${{ github.sha }} Repository: ${{ github.repository }} Branch: ${{ github.ref }} Actor: ${{ github.actor }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: failure()
Actor: ${{ github.actor }}
Check workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: failure()
