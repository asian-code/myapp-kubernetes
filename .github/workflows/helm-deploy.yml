name: 'Helm Deploy'

on:
  push:
    branches:
      - main
    paths:
      - 'helm/**'
      - 'services/**'
      - '.github/workflows/helm-deploy.yml'

env:
  HELM_CHART_PATH: helm/myhealth
  AWS_REGION: us-east-1
  DOCKER_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

jobs:
  deploy-prod:
    name: 'Deploy to Production'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.eric-n.com
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Helm
      uses: azure/setup-helm@v4
      with:
        version: 'v3.13.0'
    
    - name: Add Helm Repos
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1
    
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name myhealth-cluster --region us-east-1
    
    - name: Deploy Helm Chart (Production)
      run: |
        helm dependency update ${{ env.HELM_CHART_PATH }}
        helm upgrade --install myhealth ${{ env.HELM_CHART_PATH }} \
          --namespace myhealth-prod \
          --create-namespace \
          --values ${{ env.HELM_CHART_PATH }}/values.yaml \
          --values ${{ env.HELM_CHART_PATH }}/values-prod.yaml \
          --set global.environment=prod \
          --set imageRegistry=${{ env.DOCKER_REGISTRY }} \
          --set ouraCollector.image.tag=${{ github.sha }} \
          --set dataProcessor.image.tag=${{ github.sha }} \
          --set apiService.image.tag=${{ github.sha }} \
          --wait --timeout 10m
    
    - name: Verify Deployment (Production)
      run: |
        kubectl rollout status deployment/data-processor -n myhealth-prod --timeout=10m || true
        kubectl rollout status deployment/api-service -n myhealth-prod --timeout=10m || true
        kubectl get pods -n myhealth-prod
        kubectl get services -n myhealth-prod
    
    - name: Health Check
      run: |
        # Wait for service to be ready
        sleep 10
        kubectl port-forward -n myhealth-prod svc/api-service 8080:8080 &
        sleep 2
        curl -f http://localhost:8080/health || echo "Health check may require additional setup"
      continue-on-error: true
    
    - name: Send Notification - Success
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Production Deployment - SUCCESS" \
          -H "Priority: 3" \
          -H "Tags: deployment,production,success" \
          -d "Production deployment completed successfully! Commit: ${{ github.sha }} Repository: ${{ github.repository }} Branch: ${{ github.ref }} Actor: ${{ github.actor }} URL: https://api.eric-n.com" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: success()
    
    - name: Send Notification - Failure
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Production Deployment - FAILED" \
          -H "Priority: 5" \
          -H "Tags: deployment,production,failed,error" \
          -d "Production deployment FAILED! Commit: ${{ github.sha }} Repository: ${{ github.repository }} Branch: ${{ github.ref }} Actor: ${{ github.actor }} Check workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: failure()

