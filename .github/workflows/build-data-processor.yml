name: 'Build data-processor'

on:
  pull_request:
    paths:
      - 'services/data-processor/**'
      - 'services/shared/**'
      - '.github/workflows/build-data-processor.yml'
  push:
    branches:
      - main
    paths:
      - 'services/data-processor/**'
      - 'services/shared/**'

env:
  SERVICE_NAME: data-processor
  AWS_REGION: us-east-1
  DOCKER_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

jobs:
  test:
    name: 'Test'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Go fmt
      run: |
        cd services
        go work sync
        go fmt ./${{ env.SERVICE_NAME }}/... ./shared/...
      continue-on-error: true
    
    - name: Go vet
      run: |
        cd services
        go vet ./${{ env.SERVICE_NAME }}/... ./shared/...
    
    - name: Go test
      run: |
        cd services
        go test -v -race -coverprofile=coverage.out ./${{ env.SERVICE_NAME }}/... ./shared/...
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./services/coverage.out
        fail_ci_if_error: false
  
  build-and-push:
    name: 'Build & Push'
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to ECR
      run: |
        aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.DOCKER_REGISTRY }}
    
    - name: Build Docker image
      run: |
        cd services/${{ env.SERVICE_NAME }}
        docker build \
          -t ${{ env.DOCKER_REGISTRY }}/myhealth/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          -t ${{ env.DOCKER_REGISTRY }}/myhealth/${{ env.SERVICE_NAME }}:latest \
          .
    
    - name: Push to ECR
      run: |
        docker push ${{ env.DOCKER_REGISTRY }}/myhealth/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push ${{ env.DOCKER_REGISTRY }}/myhealth/${{ env.SERVICE_NAME }}:latest
    
    - name: Send Notification - Success
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Build ${{ env.SERVICE_NAME }} - SUCCESS" \
          -H "Priority: 3" \
          -H "Tags: build,success,${{ env.SERVICE_NAME }}" \
          -d "Image pushed to ECR: ${{ env.DOCKER_REGISTRY }}/myhealth/${{ env.SERVICE_NAME }}:${{ github.sha }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: success()
    
    - name: Send Notification - Failure
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Build ${{ env.SERVICE_NAME }} - FAILED" \
          -H "Priority: 5" \
          -H "Tags: build,failed,error,${{ env.SERVICE_NAME }}" \
          -d "Build failed for ${{ env.SERVICE_NAME }}. Check workflow at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: failure()
