name: 'Helm'

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'helm/**'
      - 'services/**'
      - '.github/workflows/helm.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'helm/**'
      - 'services/**'
      - '.github/workflows/helm.yml'

env:
  HELM_CHART_PATH: helm/myhealth
  AWS_REGION: us-east-1
  DOCKER_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  API_URL: https://myhealth.eric-n.com/api

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy-prod:
    name: 'Deploy to Production'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://myhealth.eric-n.com/api
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Helm
      uses: azure/setup-helm@v4
      with:
        version: 'v3.13.0'
    
    - name: Add Helm Repos
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update
    
    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: github-actions-${{ github.run_id }}
    
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name myhealth-cluster --region us-east-1
    
    - name: Deploy Helm Chart (Production)
      run: |
        helm dependency update ${{ env.HELM_CHART_PATH }}
        helm upgrade --install myhealth ${{ env.HELM_CHART_PATH }} \
          --namespace myhealth-prod \
          --create-namespace \
          --values ${{ env.HELM_CHART_PATH }}/values.yaml \
          --values ${{ env.HELM_CHART_PATH }}/values-prod.yaml \
          --set global.environment=prod \
          --set imageRegistry=${{ env.DOCKER_REGISTRY }} \
          --set ouraCollector.image.tag=${{ github.sha }} \
          --set dataProcessor.image.tag=${{ github.sha }} \
          --set apiService.image.tag=${{ github.sha }} \
          --wait --timeout 10m
    
    - name: Verify Deployment (Production)
      run: |
        kubectl rollout status deployment/data-processor -n myhealth-prod --timeout=10m || true
        kubectl rollout status deployment/api-service -n myhealth-prod --timeout=10m || true
        kubectl get pods -n myhealth-prod
        kubectl get services -n myhealth-prod
    
    - name: Health Check
      run: |
        # Wait for service to be ready
        sleep 10
        kubectl port-forward -n myhealth-prod svc/api-service 8080:8080 &
        sleep 2
        curl -f http://localhost:8080/health || echo "Health check may require additional setup"
      continue-on-error: true
    
    - name: Send Notification - Success
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Production Deployment - SUCCESS" \
          -H "Priority: 3" \
          -H "Tags: deployment,production,success" \
          -d "Production deployment completed successfully! Commit: ${{ github.sha }} Repository: ${{ github.repository }} Branch: ${{ github.ref }} Actor: ${{ github.actor }} URL: ${{ env.API_URL }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: success()
    
    - name: Send Notification - Failure
      shell: bash
      run: |
        curl -X POST \
          -H "Title: Production Deployment - FAILED" \
          -H "Priority: 5" \
          -H "Tags: deployment,production,failed,error" \
          -d "Production deployment FAILED! Commit: ${{ github.sha }} Repository: ${{ github.repository }} Branch: ${{ github.ref }} Actor: ${{ github.actor }} Check workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          "${{ secrets.NTFY_URL }}/cicd"
      if: failure()

  release-chart:
    name: 'Release Helm Chart'
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Create gh-pages branch if not exists
        run: |
          if ! git ls-remote --exit-code --heads origin gh-pages; then
            echo "Creating gh-pages branch..."
            git checkout --orphan gh-pages
            git rm -rf .
            git commit --allow-empty -m "Initial gh-pages commit"
            git push origin gh-pages
            git checkout main
          fi

      - name: Bump chart version
        id: bump_version
        run: |
          cd helm/myhealth
          # Get current version from Chart.yaml
          CURRENT_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          echo "Current version: $CURRENT_VERSION"
          
          # Parse semantic version (assumes format: MAJOR.MINOR.PATCH)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          # Increment patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "New version: $NEW_VERSION"
          
          # Update Chart.yaml (portable approach for both Linux and macOS)
          awk -v new_version="$NEW_VERSION" '/^version:/ {$2=new_version} {print}' Chart.yaml > Chart.yaml.tmp
          mv Chart.yaml.tmp Chart.yaml
          
          # Commit the version bump
          git add Chart.yaml
          git commit -m "chore: bump chart version to $NEW_VERSION [skip ci]"
          git push
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          charts_dir: helm
          skip_existing: true
